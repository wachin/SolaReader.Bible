# SolaReader Bible v15 - Development Manual

## Introduction

SolaReader is a PyQt6-based Bible reader application for Linux that supports MyBible modules in SQLite3 format. This manual explains the implementation based on the MyBible Modules Format specification.

## MyBible Module Structure

### Database Tables

MyBible modules use the following table structure:

#### 1. Verses Table
```sql
CREATE TABLE verses (
    book_number INTEGER NOT NULL,
    chapter INTEGER NOT NULL, 
    verse INTEGER NOT NULL,
    text TEXT NOT NULL
);
```

#### 2. Books Table (Optional)
```sql
CREATE TABLE books (
    book_number INTEGER PRIMARY KEY,
    short_name TEXT NOT NULL,
    long_name TEXT NOT NULL
);
```

#### 3. Info Table (Optional)
```sql
CREATE TABLE info (
    name TEXT PRIMARY KEY,
    value TEXT NOT NULL
);
```

### Key Implementation Details

#### Database Connection and REGEXP Support

```python
def open_database(self):
    # ... connection logic ...
    
    # Register REGEXP function for exact word matching
    def regexp(expr, item):
        if item is None:
            return False
        return re.search(expr, item, re.IGNORECASE) is not None
    
    self.conn.create_function("REGEXP", 2, regexp)
```

#### Book Mapping System

MyBible modules may have different book numbering systems. SolaReader handles this with a mapping system:

```python
def load_books(self):
    # Get book numbers from verses table
    cursor.execute("SELECT DISTINCT book_number FROM verses ORDER BY book_number")
    self.verse_book_numbers = [row[0] for row in cursor.fetchall()]
    
    # Create mapping between books table and verses table
    self.books_to_verses_map = {}
    for i, book_num in enumerate(self.book_numbers):
        if i < len(self.verse_book_numbers):
            self.books_to_verses_map[book_num] = self.verse_book_numbers[i]
```

#### Navigation System

The navigation system uses a history stack for back/forward functionality:

```python
def add_to_history(self):
    current_pos = (self.current_book_idx, self.current_chapter, self.current_verse)
    
    # If we're not at the end of the history, remove future entries
    if self.current_history_index < len(self.navigation_history) - 1:
        self.navigation_history = self.navigation_history[:self.current_history_index + 1]
    
    # Add current position to history
    self.navigation_history.append(current_pos)
    self.current_history_index = len(self.navigation_history) - 1
```

#### Verse Display with Hyperlinks

Verses are displayed as clickable links using a custom URL scheme:

```python
def load_bible_text(self):
    # ... query logic ...
    
    for verse, text in rows:
        is_current = verse == self.current_verse
        bg = "background-color:#ffeb3b;" if is_current else ""
        url = f"sword://{self.db_path.name}/{book_name} {chapter}:{verse}"
        html += f"""
        <a href="{url}" style="text-decoration:none; color:black;">
            <span style="font-weight:bold; margin-right:6px; {bg}">{verse}</span>
        </a>
        {text} <br>
        """
```

#### Search Implementation

The search function uses REGEXP for exact word matching:

```python
def search_in_bible(self, query):
    # Use REGEXP to find exact word matches
    pattern = r'\b' + re.escape(query) + r'\b'
    cursor.execute("""
        SELECT book_number, chapter, verse, text FROM verses
        WHERE text REGEXP ?
    """, (pattern,))
```

## Configuration System

SolaReader uses a JSON-based configuration system:

```json
{
  "language": "en",
  "current_translation": "/path/to/translation.sqlite3",
  "modules": {
    "/path/to/translation.sqlite3": {
      "book_name": "Genesis",
      "chapter": 1,
      "verse": 1,
      "window": {
        "x": 100,
        "y": 100,
        "width": 1000,
        "height": 700
      }
    }
  }
}
```

## Internationalization

The application supports multiple languages through Qt's translation system:

```python
def load_translation(self):
    translation_file = TRANSLATIONS_DIR / f"solareader_{self.current_language}.qm"
    if translation_file.exists():
        if self.translator.load(str(translation_file)):
            QApplication.instance().installTranslator(self.translator)
```

## Development Roadmap

### Phase 1: Core Bible Reader (Completed)
- [x] SQLite3 module support
- [x] Book/chapter/verse navigation
- [x] Search functionality
- [x] Bookmark system
- [x] Multiple language support

### Phase 2: Enhanced Features
- [ ] Parallel Bible viewing
- [ ] Commentary integration
- [ ] Dictionary/lexicon support
- [ ] Reading plans
- [ ] Verse highlighting and notes
- [ ] Customizable themes

### Phase 3: Advanced Features
- [ ] Cross-platform support
- [ ] Sync with mobile devices
- [ ] Plugin system
- [ ] Audio Bible support
- [ ] Strong's numbers integration

## Module Development

To create compatible modules, follow the MyBible format:

1. Create SQLite3 database with appropriate tables
2. Populate verses table with Bible text
3. Add book names to books table (optional)
4. Add metadata to info table (optional)

Example info table values:
- `name=description, value=King James Version`
- `name=language, value=en`
- `name=version, value=1.0`

## Troubleshooting

### Common Issues

1. **Module not loading**: Check if the SQLite3 file follows MyBible format
2. **Book names not displaying**: The module may not have a books table
3. **Search not working**: Ensure the module has the verses table properly indexed

### Debug Mode

Add debug output to diagnose issues:

```python
# Enable debug output
import logging
logging.basicConfig(level=logging.DEBUG)
```

## Conclusion

SolaReader provides a solid foundation for a MyBible-compatible Bible reader on Linux. By following the MyBible module format and extending the current implementation, you can create a feature-rich Bible study application comparable to mobile solutions.

The key to further development is understanding the SQLite database structure and extending the UI to support additional features like parallel Bible viewing, commentaries, and dictionaries, all of which can be implemented as additional SQLite modules following similar patterns.
